<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --straw: #f1c40f; --spawn: #9b59b6; --chem: #e67e22; --punnet: #3498db;
            --worker: #1abc9c; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50;
            --bipin: #8e44ad; --arjun: #2980b9; --kotak: #c0392b; --success: #27ae60;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: var(--dark); line-height: 1.4; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sync-status { font-size: 11px; text-align: center; color: var(--success); margin-bottom: 10px; font-weight: bold; }
        h2 { margin-top: 0; font-size: 1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 10px; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; text-align: center; }
        .val { font-size: 1.3rem; font-weight: bold; display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-sale { background: var(--success); } .btn-yield { background: var(--yield); } .btn-waste { background: #e67e22; }
        .btn-share { background: #25D366; margin-top: 10px; } /* WhatsApp Green */
        
        .stock-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .stock-item { padding: 10px; border-radius: 8px; background: #f8f9fa; border-left: 5px solid #ddd; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .low-stock { border-left-color: var(--danger); background: #fff1f1; color: var(--danger); }
        
        .table-container { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        td, th { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: left; }
        .acc-tag { font-size: 9px; padding: 2px 5px; border-radius: 3px; color: white; font-weight: bold; margin-left: 4px; }
        .Bipin { background: var(--bipin); } .Arjun { background: var(--arjun); } .Kotak { background: var(--kotak); }
    </style>
</head>
<body>

    <h1 style="text-align:center; margin-bottom:5px;">üçÑ Farm Master Pro</h1>
    <div id="status" class="sync-status">‚úì Connected</div>

    <div class="card">
        <h2>üì¶ Stock Runway</h2>
        <div class="stock-grid" id="stock-display"></div>
    </div>

    <div class="card grid">
        <div class="full"><small>Net Profit/Loss (Total)</small><div id="net-total" class="val">‚Çπ0</div></div>
        <div><small>Sales</small><div id="sales-total" class="val" style="color:var(--success)">‚Çπ0</div></div>
        <div><small>Expenses</small><div id="exp-total" class="val" style="color:var(--danger)">‚Çπ0</div></div>
        <button class="btn-share full" onclick="shareWeeklyReport()">üì§ Share Weekly WhatsApp Report</button>
    </div>

    <div class="card"><canvas id="financeChart"></canvas></div>

    <div class="card">
        <h2>Add Expense</h2>
        <input type="date" id="e-date">
        <select id="e-cat">
            <optgroup label="Raw Materials">
                <option value="Straw">Straw (kg)</option>
                <option value="Spawn">Spawn (kg)</option>
                <option value="Bavistine">Bavistine (kg)</option>
                <option value="Formalin">Formalin (L)</option>
            </optgroup>
            <optgroup label="Packaging">
                <option value="PP Bags">PP Bags (kg)</option>
                <option value="Rubber Bands">Rubber Bands (kg)</option>
                <option value="Cotton">Cotton (Rolls)</option>
                <option value="Punnets">Punnets (Qty)</option>
            </optgroup>
            <optgroup label="Labor">
                <option value="Worker">Labor Payment</option>
            </optgroup>
        </select>
        <select id="e-paidBy">
            <option value="Bipin">Bipin</option>
            <option value="Arjun">Arjun</option>
            <option value="Kotak">Kotak Account</option>
        </select>
        <input type="number" id="e-amt" placeholder="Total Cost (‚Çπ)">
        <input type="number" id="e-qty" placeholder="Quantity Purchased">
        <button onclick="addData('exp')">Save Expense</button>
    </div>

    <div class="card">
        <h2>Add Sale</h2>
        <input type="date" id="s-date">
        <input type="text" id="s-cust" placeholder="Customer Name">
        <input type="number" id="s-qty" placeholder="Punnets Sold">
        <input type="number" id="s-price" placeholder="Rate (‚Çπ)">
        <button class="btn-sale" onclick="addData('sale')">Save Sale</button>
    </div>

    <div class="card">
        <h2>Harvest / Wastage</h2>
        <input type="date" id="hw-date">
        <div class="grid">
            <div>
                <input type="number" step="0.1" id="y-weight" placeholder="Good Yield (kg)">
                <button class="btn-yield" onclick="addData('yield')">Save Yield</button>
            </div>
            <div>
                <select id="w-type">
                    <option value="Mushroom">Mushroom (kg)</option>
                    <option value="Contaminated Bag">Contaminated (Bag)</option>
                </select>
                <input type="number" step="0.1" id="w-val" placeholder="Value">
                <button class="btn-waste" onclick="addData('waste')">Log Waste</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>History</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Detail</th><th>Value</th><th></th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIUydcxYMuzFDw1ARVU2kie0msHaX6_CATRrLcpLjja4vTwOmnG6HP3ecZH9rYtv5i/exec"; 
        let dbMaster = [];
        let myChart;

        const dailyUsage = {
            "Straw": 5, "Spawn": 0.5, "Bavistine": 0.05, "Formalin": 0.1, "PP Bags": 0.2, "Rubber Bands": 0.05, "Cotton": 0.1, "Punnets": 10
        };

        const safeNum = (val) => isNaN(parseFloat(val)) ? 0 : parseFloat(val);

        window.onload = loadCloudData;

        async function loadCloudData() {
            document.getElementById('status').innerText = "‚åõ Syncing...";
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                dbMaster = await response.json();
                renderAll();
                document.getElementById('status').innerText = "‚úì Connected";
            } catch (e) { document.getElementById('status').innerText = "‚ö† Offline"; }
        }

        async function addData(type) {
            const today = new Date().toISOString().split('T
