<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --straw: #f1c40f; --spawn: #9b59b6; --chem: #e67e22; --punnet: #3498db;
            --worker: #1abc9c; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50;
            --bipin: #8e44ad; --arjun: #2980b9; --kotak: #c0392b; --success: #27ae60;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: var(--dark); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sync-status { font-size: 11px; text-align: center; color: var(--success); margin-bottom: 10px; font-weight: bold; }
        h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-sale { background: var(--success); } .btn-yield { background: var(--yield); } .btn-waste { background: #95a5a6; }
        
        /* Stock Monitor */
        .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stock-item { padding: 8px; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #ddd; font-size: 11px; }
        .low-stock { border-left-color: var(--danger); background: #fff1f1; color: var(--danger); font-weight: bold; }
        
        /* History & Action Buttons */
        .table-container { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        td, th { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: left; }
        .tag { padding: 2px 6px; border-radius: 4px; color: white; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .acc-tag { font-size: 9px; padding: 1px 4px; border-radius: 3px; color: white; font-weight: bold; }
        .Bipin { background: var(--bipin); } .Arjun { background: var(--arjun); } .Kotak { background: var(--kotak); }
        .action-btn { background: none; color: #999; width: auto; padding: 5px; font-size: 14px; margin: 0; display: inline; }
        .del-btn:hover { color: var(--danger); } .edit-btn:hover { color: var(--success); }
    </style>
</head>
<body>

    <h1 style="text-align:center; margin-bottom:5px;">üçÑ Farm Master Pro</h1>
    <div id="status" class="sync-status">‚úì Connected</div>

    <div class="card">
        <h2>üì¶ Stock Monitor</h2>
        <div class="stock-grid" id="stock-display"></div>
    </div>

    <div class="card">
        <h2>Add Expense</h2>
        <input type="date" id="e-date">
        <select id="e-cat">
            <option value="Straw">Straw</option>
            <option value="Spawn">Spawn</option>
            <option value="PP Bags">PP Bags</option>
            <option value="Rubber Bands">Rubber Bands</option>
            <option value="Cotton">Non-absorbent Cotton</option>
            <option value="Punnets">Plastic Punnets</option>
            <option value="Worker">Worker Pay</option>
        </select>
        <select id="e-paidBy">
            <option value="Bipin">Bipin</option>
            <option value="Arjun">Arjun</option>
            <option value="Kotak">Kotak</option>
        </select>
        <input type="number" id="e-amt" placeholder="Amount (‚Çπ)">
        <input type="number" id="e-qty" placeholder="Quantity">
        <button onclick="addData('exp')">Save Expense</button>
    </div>

    <div class="card">
        <h2>Recent History</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Detail</th><th>Value</th><th></th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIUydcxYMuzFDw1ARVU2kie0msHaX6_CATRrLcpLjja4vTwOmnG6HP3ecZH9rYtv5i/exec"; 
        let dbMaster = [];

        window.onload = loadCloudData;

        async function loadCloudData() {
            document.getElementById('status').innerText = "‚åõ Syncing...";
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                dbMaster = await response.json();
                renderAll();
                document.getElementById('status').innerText = "‚úì Synced";
            } catch (e) { document.getElementById('status').innerText = "‚ö† Offline"; }
        }

        async function addData(type) {
            const today = new Date().toISOString().split('T')[0];
            let payload = { action: "add", type, date: "", details: "", amt: 0, qty: 0, paidBy: "" };

            if (type === 'exp') {
                payload.details = document.getElementById('e-cat').value;
                payload.amt = parseFloat(document.getElementById('e-amt').value) || 0;
                payload.qty = parseFloat(document.getElementById('e-qty').value) || 0;
                payload.paidBy = document.getElementById('e-paidBy').value;
                payload.date = document.getElementById('e-date').value || today;
            }
            // ... (Add sale/yield logic here as before)

            document.getElementById('status').innerText = "‚åõ Saving...";
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            loadCloudData(); // Refresh to get the new row ID
        }

        async function deleteRow(rowId) {
            if(!confirm("Delete this entry forever?")) return;
            document.getElementById('status').innerText = "‚åõ Deleting...";
            await fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ action: "delete", rowId: rowId }) 
            });
            loadCloudData();
        }

        function editRow(index) {
            const item = dbMaster[index];
            if(item.type === 'exp') {
                document.getElementById('e-date').value = item.date;
                document.getElementById('e-cat').value = item.details;
                document.getElementById('e-amt').value = item.amt;
                document.getElementById('e-qty').value = item.qty;
                document.getElementById('e-paidBy').value = item.paidBy;
                alert("The details have been moved to the Expense form above. Please correct them and Save. Don't forget to delete the old wrong entry!");
            }
        }

        function renderAll() {
            const body = document.getElementById('history-body');
            body.innerHTML = '';
            
            // Sort by date newest first
            dbMaster.sort((a,b) => new Date(b.date) - new Date(a.date));

            dbMaster.forEach((i, idx) => {
                let row = `<tr>
                    <td>${i.date}</td>
                    <td>${i.details} ${i.paidBy ? `<span class="acc-tag ${i.paidBy}">${i.paidBy[0]}</span>` : ''}</td>
                    <td>‚Çπ${i.amt || i.qty}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editRow(${idx})">‚úèÔ∏è</button>
                        <button class="action-btn del-btn" onclick="deleteRow(${i.rowId})">üóëÔ∏è</button>
                    </td>
                </tr>`;
                body.innerHTML += row;
            });
            // Update Stock Monitor (logic same as previous)
        }
    </script>
</body>
</html>
