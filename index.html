<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Pro</title>
    <style>
        :root { --straw: #f1c40f; --spawn: #9b59b6; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --success: #27ae60; --forecast: #6c5ce7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; color: var(--dark); padding-bottom: 30px; }
        .header-status { background: white; padding: 15px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; text-align: center; }
        .forecast-banner { background: var(--forecast); color: white; padding: 12px; border-radius: 8px; margin: 10px 15px; font-size: 13px; }
        .tab-bar { display: flex; background: #eee; margin: 15px; border-radius: 10px; padding: 4px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 11px; color: #666; }
        .tab-btn.active { background: white; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { padding: 0 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .stock-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stock-item { padding: 8px; border-radius: 6px; background: #f8f9fa; border-left: 3px solid #ddd; font-size: 10px; line-height: 1.2; }
        .low-stock { border-left-color: var(--danger); background: #fff1f1; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        td, th { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: left; }
        .action-btn { font-size: 16px; cursor: pointer; padding: 0 5px; }
        #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
        .modal-content { background:white; margin:15% auto; padding:20px; width:85%; border-radius:12px; }
        .ledger-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #eee; font-size: 12px; }
    </style>
</head>
<body>

<div class="header-status">
    <div id="status" style="font-size:10px; color: var(--success); margin-bottom:5px;">‚úì Connected</div>
    <div class="grid">
        <div><small>Active Bags</small><div id="active-bags" style="font-weight:bold; font-size:1.1rem;">0</div></div>
        <div><small>Avg Yield/Bag</small><div id="yield-bag" style="font-weight:bold; font-size:1.1rem; color:var(--success)">0 kg</div></div>
    </div>
</div>

<div class="forecast-banner">
    <b>üîÆ 10-DAY FORECAST: <span id="fc-yield">0 kg</span></b>
    <div id="fc-msg" style="font-size:10px; opacity:0.9; margin-top:3px;">Based on your last 28 days of production.</div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="openTab(event, 'tab-prod')">PRODUCTION</button>
    <button class="tab-btn" onclick="openTab(event, 'tab-fin')">FINANCE</button>
    <button class="tab-btn" onclick="openTab(event, 'tab-hist')">HISTORY</button>
</div>

<div class="container">
    <div id="tab-prod" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0; font-size:14px;">üõ† Log Production</h3>
            <input type="number" id="f-qty" placeholder="Number of bags filled">
            <button onclick="addData('fill')" style="background:#1abc9c">Save Production</button>
            <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
            <input type="number" step="0.1" id="y-weight" placeholder="Harvest Weight (kg)">
            <button onclick="addData('yield')" style="background:var(--yield)">Save Harvest</button>
        </div>
        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size:14px;">üì¶ Stock Runway</h3>
            <div id="stock-display" class="stock-grid"></div>
        </div>
    </div>

    <div id="tab-fin" class="tab-content" style="display:none;">
        <div class="card grid" style="text-align:center;">
            <div><small>Total Sales</small><div id="sales-total" style="color:var(--success); font-weight:bold; font-size:1.1rem;">‚Çπ0</div></div>
            <div><small>Total Expenses</small><div id="exp-total" style="color:var(--danger); font-weight:bold; font-size:1.1rem;">‚Çπ0</div></div>
        </div>
        <div class="card">
            <select id="fin-type" onchange="toggleFin(this.value)">
                <option value="sale">Record New Sale</option>
                <option value="exp">Record New Expense</option>
            </select>
            <div id="div-sale">
                <input type="text" id="s-cust" placeholder="Customer Name">
                <input type="number" id="s-qty" placeholder="Punnets Sold">
                <input type="number" id="s-rate" placeholder="Rate per punnet (‚Çπ)">
                <button onclick="addData('sale')" style="background:var(--success)">Save Sale</button>
            </div>
            <div id="div-exp" style="display:none;">
                <select id="e-cat">
                    <optgroup label="Raw Materials">
                        <option value="Straw">Straw (kg)</option>
                        <option value="Spawn">Spawn (kg)</option>
                        <option value="Bavistine">Bavistine (g)</option>
                        <option value="Formalin">Formalin (ml)</option>
                        <option value="Punnets">Punnets (pcs)</option>
                    </optgroup>
                    <optgroup label="Staff Payments">
                        <option value="Worker: Pallavi Mavshi">Pallavi Mavshi</option>
                        <option value="Worker: Bhabhi">Bhabhi</option>
                        <option value="Worker: Sangeeta Mavshi">Sangeeta Mavshi</option>
                        <option value="Labor: General">General Labor</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="Transport">Transport</option>
                        <option value="Misc">Misc</option>
                    </optgroup>
                </select>
                <input type="number" id="e-amt" placeholder="Total Amount (‚Çπ)">
                <input type="number" id="e-qty" placeholder="Quantity (kg/g/pcs)">
                <button onclick="addData('exp')" style="background:var(--danger)">Save Expense</button>
            </div>
        </div>
        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size:14px;">üë©‚Äçüåæ Staff Payment Ledger</h3>
            <div id="worker-list"></div>
        </div>
    </div>

    <div id="tab-hist" class="tab-content" style="display:none;">
        <div class="card">
            <input type="text" id="h-search" placeholder="üîç Search History..." onkeyup="filterHistory()">
            <div style="max-height:400px; overflow-y:auto;">
                <table>
                    <thead><tr><th>Date</th><th>Detail</th><th>Amt/Qty</th><th>Action</th></tr></thead>
                    <tbody id="h-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit Entry</h3>
        <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
        <label><small>Date</small></label><input type="date" id="edit-date">
        <label><small>Description</small></label><input type="text" id="edit-details">
        <label><small>Amount (‚Çπ or kg)</small></label><input type="number" step="0.1" id="edit-amt">
        <label><small>Quantity</small></label><input type="number" step="0.1" id="edit-qty">
        <div class="grid">
            <button onclick="closeEdit()">Cancel</button>
            <button onclick="submitEdit()" style="background:var(--success)">Save Changes</button>
        </div>
    </div>
</div>

<script>
    const GOOGLE_URL = "YOUR_NEW_DEPLOYMENT_URL_HERE";
    let db = [];
    const usage = { "Straw": 1.5, "Spawn": 0.12, "Punnets": 10, "Bavistine": 0.5, "Formalin": 5 };

    async function load() {
        document.getElementById('status').innerText = "‚åõ Syncing...";
        try {
            const r = await fetch(GOOGLE_URL);
            db = await r.json();
            render();
            document.getElementById('status').innerText = "‚úì Connected";
        } catch(e) { document.getElementById('status').innerText = "‚ö† Offline"; }
    }

    function render() {
        let s = { "Straw": 0, "Spawn": 0, "Punnets": 0, "Bavistine": 0, "Formalin": 0 };
        let workers = { "Pallavi Mavshi": 0, "Bhabhi": 0, "Sangeeta Mavshi": 0 };
        let actB = 0, fcy = 0, ty = 0, tf = 0, ts = 0, te = 0;
        const now = new Date();

        db.forEach(i => {
            const v = parseFloat(i.amt)||0, q = parseFloat(i.qty)||0, d = new Date(i.date);
            const detail = i.details || "";

            if(i.type==='exp'){ 
                te+=v; 
                if(detail.includes("Straw")) s["Straw"]+=q;
                if(detail.includes("Spawn")) s["Spawn"]+=q;
                if(detail.includes("Bavistine")) s["Bavistine"]+=q;
                if(detail.includes("Formalin")) s["Formalin"]+=q;
                if(detail.includes("Punnets")) s["Punnets"]+=q;
                for(let name in workers) { if(detail.includes(name)) workers[name]+=v; }
            }
            if(i.type==='sale'){ ts+=v; s["Punnets"]-=q; }
            if(i.type==='fill'){ 
                tf+=q; actB+=q; 
                s["Straw"]-=(q*1.5); s["Spawn"]-=(q*0.12); s["Bavistine"]-=(q*0.5); s["Formalin"]-=(q*5);
                if((now-d)/86400000 < 28) fcy+=(q*0.6); 
            }
            if(i.type==='yield'){ ty+=v; }
        });

        document.getElementById('active-bags').innerText = Math.max(0, actB);
        document.getElementById('yield-bag').innerText = tf ? (ty/tf).toFixed(2)+'kg' : '0kg';
        document.getElementById('sales-total').innerText = '‚Çπ'+ts;
        document.getElementById('exp-total').innerText = '‚Çπ'+te;
        document.getElementById('fc-yield').innerText = fcy.toFixed(1)+'kg';
        
        let stockH = '';
        for(let k in s) {
            let daily = (k === "Straw") ? 15 : (k === "Spawn" ? 1.2 : 10);
            let days = Math.floor(s[k]/daily);
            stockH += `<div class="stock-item ${days < 3 ? 'low-stock' : ''}"><b>${k}</b><br>${s[k].toFixed(1)}<br>${days < 0 ? 0 : days}d</div>`;
        }
        document.getElementById('stock-display').innerHTML = stockH;

        let workH = '';
        for(let name in workers) {
            workH += `<div class="ledger-row"><span>${name}</span><b>‚Çπ${workers[name]}</b></div>`;
        }
        document.getElementById('worker-list').innerHTML = workH;

        let histH = '';
        db.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(i => {
            histH += `<tr><td>${i.date.split('T')[0]}</td><td>${i.details}</td><td>${i.type==='sale'||i.type==='exp'?'‚Çπ'+i.amt : i.qty}</td>
            <td><span class="action-btn" onclick="startEdit(${i.rowId})">‚úèÔ∏è</span> <span class="action-btn" onclick="del(${i.rowId})">üóëÔ∏è</span></td></tr>`;
        });
        document.getElementById('h-body').innerHTML = histH;
    }

    async function addData(type) {
        let p = { action:"add", type, date: new Date().toISOString().split('T')[0], details:"", amt:0, qty:0, paidBy:"Bipin" };
        if(type==='fill'){ p.qty=document.getElementById('f-qty').value; p.details="Bags Filled"; }
        if(type==='yield'){ p.amt=document.getElementById('y-weight').value; p.details="Harvest"; }
        if(type==='sale'){ p.qty=document.getElementById('s-qty').value; p.amt=p.qty*document.getElementById('s-rate').value; p.details="Sale: "+document.getElementById('s-cust').value; }
        if(type==='exp'){ p.details=document.getElementById('e-cat').value; p.amt=document.getElementById('e-amt').value; p.qty=document.getElementById('e-qty').value; }
        
        document.getElementById('status').innerText = "‚åõ Saving...";
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        setTimeout(load, 1500);
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).style.display='block';
        e.currentTarget.classList.add('active');
    }
    function toggleFin(v) { document.getElementById('div-sale').style.display=v==='sale'?'block':'none'; document.getElementById('div-exp').style.display=v==='exp'?'block':'none'; }
    
    function startEdit(id) { 
        let i = db.find(x=>x.rowId===id); 
        document.getElementById('edit-id').value=i.rowId; document.getElementById('edit-date').value=i.date.split('T')[0];
        document.getElementById('edit-details').value=i.details; document.getElementById('edit-amt').value=i.amt;
        document.getElementById('edit-qty').value=i.qty; document.getElementById('edit-type').value=i.type;
        document.getElementById('editModal').style.display='block'; 
    }
    function closeEdit() { document.getElementById('editModal').style.display='none'; }
    
    async function submitEdit() {
        let p = { action:"edit", rowId:document.getElementById('edit-id').value, date:document.getElementById('edit-date').value, 
                  details:document.getElementById('edit-details').value, amt:document.getElementById('edit-amt').value, 
                  qty:document.getElementById('edit-qty').value, type:document.getElementById('edit-type').value, paidBy:"Bipin" };
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        closeEdit(); setTimeout(load, 1500);
    }
    
    async function del(id) { if(confirm("Permanently delete this entry?")) { await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:"delete", rowId:id})}); setTimeout(load, 1500); } }
    
    function filterHistory() {
        let val = document.getElementById('h-search').value.toLowerCase();
        document.querySelectorAll('#h-body tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
    }
    window.onload = load;
</script>
</body>
</html>
