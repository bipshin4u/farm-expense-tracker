<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Pro</title>
    <style>
        :root { --straw: #f1c40f; --spawn: #9b59b6; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --success: #27ae60; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; color: var(--dark); overflow-y: auto; }
        
        .header-status { background: white; padding: 12px; border-bottom: 1px solid #ddd; text-align: center; position: sticky; top: 0; z-index: 200; }
        .main-container { padding: 10px 15px; }
        
        .tab-bar { display: flex; background: #eee; margin-bottom: 15px; border-radius: 10px; padding: 4px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 12px; color: #666; }
        .tab-btn.active { background: white; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { background: var(--dark); color: white; font-weight: bold; border: none; cursor: pointer; }
        
        .row-arjun { background-color: #e3f2fd !important; }
        .row-kotak { background-color: #fff9c4 !important; }
        .row-waste { color: var(--danger); background-color: #ffebee !important; }

        .history-section { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .history-header { 
            padding: 15px; background: #f8f9fa; border-radius: 12px 12px 0 0; border-bottom: 1px solid #eee; 
            position: sticky; top: 75px; z-index: 150; 
        }
        .search-bar { padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; width: 100%; font-size: 14px; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        td, th { padding: 12px 6px; border-bottom: 1px solid #eee; text-align: left; }
        .action-btn { cursor: pointer; font-size: 16px; margin-right: 12px; display: inline-block; }
        .del-btn { color: var(--danger); }
        
        #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
        .modal-content { background:white; margin:15% auto; padding:20px; width:85%; border-radius:12px; }
    </style>
</head>
<body>

<div class="header-status">
    <div id="status" style="font-size:11px; font-weight:bold; color: orange; margin-bottom: 5px;">‚åõ Connecting...</div>
    <div class="grid" style="max-width: 400px; margin: 0 auto;">
        <div><small>Bags</small><div id="active-bags" style="font-weight:bold;">0</div></div>
        <div><small>Profit</small><div id="net-profit" style="font-weight:bold; color:var(--success)">‚Çπ0</div></div>
    </div>
</div>

<div class="main-container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="openTab(event, 'tab-prod')">PRODUCTION</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-fin')">FINANCE</button>
    </div>

    <div id="tab-prod" class="tab-content">
        <div class="card">
            <h3 style="margin-top:0">üõ† Production</h3>
            <div class="grid"><input type="number" id="f-qty" placeholder="Bags filled"><button onclick="addData('fill')" style="background:#1abc9c">Save</button></div>
            <div class="grid"><input type="number" step="0.1" id="y-weight" placeholder="Harvest kg"><button onclick="addData('yield')" style="background:var(--yield)">Save</button></div>
        </div>
        <div class="card" style="border-left: 5px solid var(--danger);">
            <h3 style="margin-top:0">‚ö†Ô∏è Wastage</h3>
            <select id="w-type"><option value="Contaminated Bag">Contaminated Bag</option><option value="Spoilt Mushroom">Spoilt Mushroom</option></select>
            <input type="number" step="0.1" id="w-qty" placeholder="Quantity"><button onclick="addData('waste')" style="background:var(--danger)">Record Loss</button>
        </div>
    </div>

    <div id="tab-fin" class="tab-content" style="display:none;">
        <div class="card">
            <h3 style="margin-top:0">üí∞ Transactions</h3>
            <select id="fin-type" onchange="toggleFin(this.value)"><option value="sale">Record Sale</option><option value="exp">Record Expense</option></select>
            <div id="acc-div" style="display:none;">
                <select id="acc-select">
                    <option value="Bipin">Account: Bipin</option>
                    <option value="Arjun">Account: Arjun</option>
                    <option value="Kotak Account">Account: Kotak</option>
                </select>
            </div>
            <div id="div-sale">
                <input type="text" id="s-cust" placeholder="Customer Name"><input type="number" id="s-qty" placeholder="Punnets"><input type="number" id="s-rate" placeholder="Rate"><button onclick="addData('sale')" style="background:var(--success)">Save Sale</button>
            </div>
            <div id="div-exp" style="display:none;">
                <select id="e-cat">
                    <optgroup label="Staff"><option value="Worker: Pallavi Mavshi">Pallavi Mavshi</option><option value="Worker: Bhabhi">Bhabhi</option><option value="Worker: Sangeeta Mavshi">Sangeeta Mavshi</option></optgroup>
                    <optgroup label="Materials"><option value="Straw">Straw</option><option value="Spawn">Spawn</option><option value="PP Bags">PP Bags</option></optgroup>
                    <optgroup label="Other"><option value="Rent">Rent</option><option value="Electricity">Electricity</option><option value="Transport">Transport</option><option value="Misc">Misc</option></optgroup>
                </select>
                <input type="number" id="e-amt" placeholder="Amount (‚Çπ)"><input type="number" id="e-qty" placeholder="Qty"><button onclick="addData('exp')" style="background:var(--danger)">Save Expense</button>
            </div>
        </div>
        <div class="card">
            <h3>üìä Ledger Summary</h3>
            <div id="ledger-summary">Loading...</div>
        </div>
    </div>

    <div class="history-section">
        <div class="history-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold">üìú HISTORY</span>
                <small id="row-count">0 Records</small>
            </div>
            <input type="text" id="h-search" class="search-bar" placeholder="üîç Search records..." onkeyup="filterHistory()">
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Date</th><th>Detail</th><th>Val</th><th>By</th><th>Actions</th></tr></thead>
                <tbody id="h-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit Entry</h3>
        <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
        <label><small>Date</small></label><input type="date" id="edit-date">
        <input type="text" id="edit-details">
        <div class="grid">
            <input type="number" id="edit-amt" placeholder="Amt">
            <input type="number" step="0.1" id="edit-qty" placeholder="Qty">
        </div>
        <div id="edit-acc-div">
            <label><small>Paid By</small></label>
            <select id="edit-paidBy">
                <option value="Bipin">Bipin</option><option value="Arjun">Arjun</option><option value="Kotak Account">Kotak Account</option>
            </select>
        </div>
        <div class="grid"><button onclick="closeEdit()">Cancel</button><button onclick="submitEdit()" style="background:var(--success)">Update</button></div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbx84NAhMzcC5bz0-XyLoM-1a-QOOZDcQNVWdXT3EYt428BhwqcY5yWrXEDCV3LkMgEs/exec";
    let db = [];

    function safeSet(id, val) { const el = document.getElementById(id); if (el) el.innerText = val; }

    async function load() {
        safeSet('status', "‚åõ Connecting...");
        try {
            const r = await fetch(GOOGLE_URL);
            db = await r.json();
            render();
            safeSet('status', "‚úì Connected");
            document.getElementById('status').style.color = "var(--success)";
        } catch(e) { safeSet('status', "‚ö† Offline"); }
    }

    function render() {
        let workers = { "Pallavi Mavshi": 0, "Bhabhi": 0, "Sangeeta Mavshi": 0 };
        let accounts = { "Bipin": 0, "Arjun": 0, "Kotak Account": 0 };
        let actB = 0, ts = 0, te = 0;
        const hBody = document.getElementById('h-body');
        if(!hBody) return;
        hBody.innerHTML = '';
        
        db.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(i => {
            const v = parseFloat(i.amt) || 0;
            const q = parseFloat(i.qty) || 0;
            const detRaw = (i.details || "").toString();
            const detLower = detRaw.toLowerCase();
            const rawTag = (i.type || "").toString().trim().toLowerCase();

            // DIRECT KEY ACCESS (matched to your debugger output)
            let whoPaid = (i.paidBy || "").toString().trim();
            const isExp = (rawTag === 'exp' || detLower.startsWith('expense:'));
            
            let rowClass = "";
            let tableDisplayName = ""; 

            if (isExp) {
                te += v;
                // Check content of paidBy to assign to ledger and color
                if (whoPaid.toLowerCase().includes("arjun")) {
                    accounts["Arjun"] += v;
                    rowClass = "row-arjun";
                    tableDisplayName = "Arjun";
                } else if (whoPaid.toLowerCase().includes("kotak")) {
                    accounts["Kotak Account"] += v;
                    rowClass = "row-kotak";
                    tableDisplayName = "Kotak";
                } else {
                    accounts["Bipin"] += v;
                    tableDisplayName = "Bipin";
                }
            }

            if (rawTag === 'waste') rowClass = "row-waste";
            if (rawTag === 'sale') ts += v;
            if (rawTag === 'fill') actB += q;
            if (rawTag === 'waste' && detLower.includes("contaminated")) actB -= q;

            if (detLower.includes("pallavi")) workers["Pallavi Mavshi"] += v;
            else if (detLower.includes("sangeeta")) workers["Sangeeta Mavshi"] += v;
            else if (detLower.includes("bhabhi")) workers["Bhabhi"] += v;

            hBody.innerHTML += `<tr class="${rowClass}">
                <td>${(i.date||"").split('T')[0].substring(5)}</td>
                <td>${detRaw}</td>
                <td>${v || q}</td>
                <td style="font-weight:bold;">${tableDisplayName}</td> 
                <td style="white-space:nowrap">
                    <span class="action-btn" onclick="startEdit(${i.rowId})">‚úèÔ∏è</span>
                    <span class="action-btn del-btn" onclick="delEntry(${i.rowId})">üóëÔ∏è</span>
                </td>
            </tr>`;
        });

        safeSet('net-profit', '‚Çπ' + (ts - te).toFixed(2));
        safeSet('active-bags', actB);
        safeSet('row-count', db.length + " Records");

        const ledSum = document.getElementById('ledger-summary');
        if(ledSum) {
            let html = `<b>Staff Totals</b>`;
            for(let w in workers) { html += `<div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;"><span>${w}</span><b>‚Çπ${workers[w].toFixed(2)}</b></div>`; }
            html += `<hr><b>Expenses by Account</b>`;
            for(let acc in accounts) { html += `<div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;"><span>${acc}</span><b>‚Çπ${accounts[acc].toFixed(2)}</b></div>`; }
            ledSum.innerHTML = html;
        }
    }

    async function addData(type) {
        let p = { action:"add", type, date: new Date().toISOString().split('T')[0], details:"", amt:0, qty:0, paidBy: "" };
        if(type==='exp') p.paidBy = document.getElementById('acc-select').value;
        if(type==='fill'){ p.qty=document.getElementById('f-qty').value; p.details="Bags Filled"; }
        if(type==='yield'){ p.amt=document.getElementById('y-weight').value; p.details="Harvest"; }
        if(type==='waste'){ p.qty=document.getElementById('w-qty').value; p.details="Waste: " + document.getElementById('w-type').value; }
        if(type==='sale'){ p.qty=document.getElementById('s-qty').value; p.amt=p.qty*document.getElementById('s-rate').value; p.details="Sale: "+document.getElementById('s-cust').value; }
        if(type==='exp'){ p.details=document.getElementById('e-cat').value; p.amt=document.getElementById('e-amt').value; p.qty=document.getElementById('e-qty').value; }
        safeSet('status', "‚åõ Saving...");
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        document.querySelectorAll('.main-container input').forEach(input => { if(input.id !== 'h-search') input.value = ''; });
        setTimeout(load, 1500);
    }

    function startEdit(id) {
        let i = db.find(x => x.rowId == id);
        if(!i) return;
        document.getElementById('edit-id').value = i.rowId;
        document.getElementById('edit-type').value = i.type || 'exp';
        document.getElementById('edit-date').value = (i.date||"").split('T')[0];
        document.getElementById('edit-details').value = i.details;
        document.getElementById('edit-amt').value = i.amt;
        document.getElementById('edit-qty').value = i.qty;
        const accDiv = document.getElementById('edit-acc-div');
        if(document.getElementById('edit-type').value === 'exp') { 
            accDiv.style.display = 'block'; 
            document.getElementById('edit-paidBy').value = (i.paidBy || "Bipin"); 
        } else { accDiv.style.display = 'none'; }
        document.getElementById('editModal').style.display = 'block';
    }

    async function submitEdit() {
        let p = { action:"edit", rowId: document.getElementById('edit-id').value, type: document.getElementById('edit-type').value, date: document.getElementById('edit-date').value, details: document.getElementById('edit-details').value, amt: document.getElementById('edit-amt').value, qty: document.getElementById('edit-qty').value, paidBy: document.getElementById('edit-paidBy').value };
        safeSet('status', "‚åõ Updating...");
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        closeEdit(); setTimeout(load, 1500);
    }

    async function delEntry(id) {
        if(confirm("Delete this record?")) {
            safeSet('status', "‚åõ Deleting...");
            await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:"delete", rowId:id})});
            setTimeout(load, 1500);
        }
    }

    function toggleFin(v) { 
        document.getElementById('div-sale').style.display = v==='sale'?'block':'none'; 
        document.getElementById('div-exp').style.display = v==='exp'?'block':'none'; 
        document.getElementById('acc-div').style.display = v==='exp'?'block':'none'; 
    }
    function filterHistory() {
        let val = document.getElementById('h-search').value.toLowerCase();
        document.querySelectorAll('#h-body tr').forEach(r => { r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none'; });
    }
    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).style.display='block'; e.currentTarget.classList.add('active');
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    window.onload = load;
</script>
</body>
</html>
