<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Cloud Pro + Wastage</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --straw: #f1c40f; --spawn: #9b59b6; --chem: #e67e22; --punnet: #3498db;
            --worker: #1abc9c; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50;
            --bipin: #8e44ad; --arjun: #2980b9; --kotak: #c0392b;
        }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-yield { background: var(--yield); }
        .btn-waste { background: #95a5a6; border: 1px dashed #7f8c8d; color: white; }
        .stock-item { padding: 8px; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #ddd; font-size: 11px; }
        .low-stock { border-left-color: var(--danger); background: #fff1f1; color: var(--danger); }
        .sync-status { font-size: 11px; text-align: center; color: #27ae60; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1 style="text-align:center;">üçÑ Farm Pro + Wastage</h1>
    <div id="status" class="sync-status">‚úì Cloud Connected</div>

    <div class="card">
        <h2>üì¶ Stock Monitor</h2>
        <div class="grid" id="stock-display"></div>
    </div>

    <div class="card">
        <h2>Log Harvest / Wastage</h2>
        <input type="date" id="hw-date">
        <div class="grid">
            <div>
                <label><small>Good Yield (kg)</small></label>
                <input type="number" step="0.1" id="y-weight" placeholder="Weight">
                <button class="btn-yield" onclick="addData('yield')">Save Harvest</button>
            </div>
            <div>
                <label><small>Wastage (Bags)</small></label>
                <input type="number" id="w-bags" placeholder="Failed Bags">
                <button class="btn-waste" onclick="addData('waste')">Log Wastage</button>
            </div>
        </div>
        <p style="font-size: 10px; color: #666;">*Harvest reduces punnets/bags. Wastage reduces straw/spawn/bags.</p>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLa5Aa20B1T8XTaa0VYzEk8HoWvL2dU-iGXVEogmO2bvthvD1kxmUH-gnI0Vka2ZrM/exec"; 
        let db = { exp: [], sales: [], yield: [], waste: [] };
        const limits = { "Straw": 5, "Spawn": 2, "PP Bags": 50, "Punnets": 100 };

        async function loadCloudData() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const cloudData = await response.json();
                
                let newDb = { exp: [], sales: [], yield: [], waste: [] };
                cloudData.forEach(item => {
                    if (item.type === 'exp') newDb.exp.push(item);
                    else if (item.type === 'sale') newDb.sales.push(item);
                    else if (item.type === 'yield') newDb.yield.push(item);
                    else if (item.type === 'waste') newDb.waste.push(item);
                });
                db = newDb;
                renderStock();
            } catch (e) { console.log("Sync Error"); }
        }

        function calculateStock() {
            let stock = { "Straw": 0, "Spawn": 0, "PP Bags": 0, "Punnets": 0 };
            
            // 1. ADD FROM PURCHASES
            db.exp.forEach(e => {
                if(stock.hasOwnProperty(e.details)) stock[e.details] += (parseFloat(e.qty) || 0);
            });

            // 2. SUBTRACT FROM HARVEST (Packed items)
            db.yield.forEach(y => {
                stock["PP Bags"] -= (y.weight * 2); // 2 bags per kg
                stock["Punnets"] -= (y.weight * 5); // 5 punnets per kg
            });

            // 3. SUBTRACT FROM WASTAGE (Raw materials lost)
            db.waste.forEach(w => {
                const bagsLost = parseFloat(w.qty) || 0;
                stock["PP Bags"] -= bagsLost;
                stock["Straw"] -= (bagsLost * 0.5); // Estimate 0.5kg straw per bag
                stock["Spawn"] -= (bagsLost * 0.1); // Estimate 100g spawn per bag
            });

            return stock;
        }

        function renderStock() {
            const stock = calculateStock();
            const container = document.getElementById('stock-display');
            container.innerHTML = '';
            for (let item in stock) {
                let isLow = stock[item] <= limits[item];
                container.innerHTML += `<div class="stock-item ${isLow ? 'low-stock' : ''}">${item}: ${stock[item].toFixed(1)}</div>`;
            }
        }

        async function addData(type) {
            const today = new Date().toISOString().split('T')[0];
            let payload = { type, date: document.getElementById('hw-date').value || today, details: "", qty: 0 };

            if (type === 'yield') {
                payload.weight = parseFloat(document.getElementById('y-weight').value) || 0;
                payload.details = "Harvest";
                db.yield.unshift(payload);
            } else if (type === 'waste') {
                payload.qty = parseFloat(document.getElementById('w-bags').value) || 0;
                payload.details = "Wastage";
                db.waste.unshift(payload);
            }

            // Sync to Google
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            location.reload(); 
        }
    </script>
</body>
</html>
