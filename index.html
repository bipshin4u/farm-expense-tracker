<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --straw: #f1c40f; --spawn: #9b59b6; --chem: #e67e22; --punnet: #3498db;
            --worker: #1abc9c; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50;
            --bipin: #8e44ad; --arjun: #2980b9; --kotak: #c0392b; --success: #27ae60;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: var(--dark); line-height: 1.4; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .sync-status { font-size: 11px; text-align: center; color: var(--success); margin-bottom: 10px; font-weight: bold; }
        h2 { margin-top: 0; font-size: 1rem; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 10px; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; text-align: center; }
        .val { font-size: 1.3rem; font-weight: bold; display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-sale { background: var(--success); } .btn-yield { background: var(--yield); } .btn-waste { background: #e67e22; }
        .btn-share { background: #25D366; margin-top: 10px; }
        .stock-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .stock-item { padding: 10px; border-radius: 8px; background: #f8f9fa; border-left: 5px solid #ddd; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .low-stock { border-left-color: var(--danger); background: #fff1f1; color: var(--danger); }
        .table-container { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        td, th { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: left; }
        .acc-tag { font-size: 9px; padding: 2px 5px; border-radius: 3px; color: white; font-weight: bold; margin-left: 4px; }
        .Bipin { background: var(--bipin); } .Arjun { background: var(--arjun); } .Kotak { background: var(--kotak); }
        .actions { display: flex; gap: 10px; color: #888; cursor: pointer; }
    </style>
</head>
<body>

    <h1 style="text-align:center; margin-bottom:5px;">üçÑ Farm Master Pro</h1>
    <div id="status" class="sync-status">‚úì Connected</div>

    <div class="card">
        <h2>üì¶ Stock Runway (Days Left)</h2>
        <div id="stock-display" class="stock-grid"></div>
    </div>

    <div class="card grid">
        <div class="full"><small>Net Profit/Loss (Total)</small><div id="net-total" class="val">‚Çπ0</div></div>
        <div><small>Sales</small><div id="sales-total" class="val" style="color:var(--success)">‚Çπ0</div></div>
        <div><small>Expenses</small><div id="exp-total" class="val" style="color:var(--danger)">‚Çπ0</div></div>
        <button class="btn-share full" onclick="shareWeeklyReport()">üì§ Share Weekly WhatsApp Report</button>
    </div>

    <div class="card"><canvas id="financeChart"></canvas></div>

    <div class="card" id="expense-form">
        <h2>Add Expense</h2>
        <input type="date" id="e-date">
        <select id="e-cat">
            <optgroup label="Raw Materials">
                <option value="Straw">Straw (kg)</option>
                <option value="Spawn">Spawn (kg)</option>
                <option value="Bavistine">Bavistine (kg)</option>
                <option value="Formalin">Formalin (L)</option>
            </optgroup>
            <optgroup label="Packaging">
                <option value="PP Bags">PP Bags (kg)</option>
                <option value="Rubber Bands">Rubber Bands (kg)</option>
                <option value="Cotton">Cotton (Rolls)</option>
                <option value="Punnets">Punnets (Qty)</option>
            </optgroup>
            <optgroup label="Labor Payments">
                <option value="Pallavi Mavshi">Pallavi Mavshi</option>
                <option value="Sangeeta Mavshi">Sangeeta Mavshi</option>
                <option value="Bhabhi">Bhabhi</option>
                <option value="Other Worker">Other Worker</option>
            </optgroup>
            <optgroup label="Fixed Costs">
                <option value="Rent">Rent</option>
                <option value="Electricity">Electricity</option>
            </optgroup>
            <optgroup label="General">
                <option value="Miscellaneous">Miscellaneous</option>
            </optgroup>
        </select>
        <select id="e-paidBy">
            <option value="Bipin">Bipin</option>
            <option value="Arjun">Arjun</option>
            <option value="Kotak">Kotak Account</option>
        </select>
        <input type="number" id="e-amt" placeholder="Total Cost (‚Çπ)">
        <input type="number" id="e-qty" placeholder="Quantity Purchased">
        <button onclick="addData('exp')">Save Expense</button>
    </div>

    <div class="card">
        <h2>Add Sale</h2>
        <input type="date" id="s-date">
        <input type="text" id="s-cust" placeholder="Customer Name">
        <input type="number" id="s-qty" placeholder="Punnets Sold">
        <input type="number" id="s-price" placeholder="Rate (‚Çπ)">
        <button class="btn-sale" onclick="addData('sale')">Save Sale</button>
    </div>

    <div class="card">
        <h2>Harvest / Wastage</h2>
        <input type="date" id="hw-date">
        <div class="grid">
            <div>
                <input type="number" step="0.1" id="y-weight" placeholder="Yield (kg)">
                <button class="btn-yield" onclick="addData('yield')">Save Yield</button>
            </div>
            <div>
                <select id="w-type">
                    <option value="Mushroom">Mushroom (kg)</option>
                    <option value="Contaminated Bag">Contaminated (Bag)</option>
                </select>
                <input type="number" step="0.1" id="w-val" placeholder="Qty or kg">
                <button class="btn-waste" onclick="addData('waste')">Log Waste</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>History</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Detail</th><th>Value</th><th>Action</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFMQadF8BEZ_7T5VW3VfprN4oa_srF_nSfXvlM6RVV6oEnERmCp-UymFl_ts3nEd6Z/exec"; 
        let dbMaster = [];
        let myChart;

        const dailyUsage = { "Straw": 5, "Spawn": 0.5, "Bavistine": 0.05, "Formalin": 0.1, "PP Bags": 0.2, "Rubber Bands": 0.05, "Cotton": 0.1, "Punnets": 10 };
        const safeNum = (val) => isNaN(parseFloat(val)) ? 0 : parseFloat(val);

        window.onload = loadCloudData;

        async function loadCloudData() {
            document.getElementById('status').innerText = "‚åõ Syncing...";
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                dbMaster = await response.json();
                renderAll();
                document.getElementById('status').innerText = "‚úì Connected";
            } catch (e) { document.getElementById('status').innerText = "‚ö† Offline"; }
        }

        async function addData(type) {
            const today = new Date().toISOString().split('T')[0];
            let payload = { action: "add", type, date: document.getElementById(type==='exp'?'e-date':(type==='sale'?'s-date':'hw-date')).value || today, details: "", amt: 0, qty: 0, paidBy: "" };

            if (type === 'exp') {
                payload.details = document.getElementById('e-cat').value;
                payload.amt = safeNum(document.getElementById('e-amt').value);
                payload.qty = safeNum(document.getElementById('e-qty').value);
                payload.paidBy = document.getElementById('e-paidBy').value;
            } else if (type === 'sale') {
                const q = safeNum(document.getElementById('s-qty').value);
                const p = safeNum(document.getElementById('s-price').value);
                payload.amt = q * p; payload.qty = q;
                payload.details = "Sale: " + (document.getElementById('s-cust').value || "Retail");
            } else if (type === 'yield') {
                payload.amt = safeNum(document.getElementById('y-weight').value);
                payload.details = "Harvest";
            } else if (type === 'waste') {
                payload.amt = safeNum(document.getElementById('w-val').value);
                payload.details = "Waste: " + document.getElementById('w-type').value;
            }

            document.getElementById('status').innerText = "‚åõ Saving...";
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            loadCloudData();
            ['e-amt','e-qty','s-cust','s-qty','s-price','y-weight','w-val'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ''; });
        }

        function editRow(rowId) {
            const item = dbMaster.find(i => i.rowId == rowId);
            if (!item) return;
            if (item.type === 'exp') {
                document.getElementById('e-date').value = item.date.split('T')[0];
                document.getElementById('e-cat').value = item.details;
                document.getElementById('e-amt').value = item.amt;
                document.getElementById('e-qty').value = item.qty;
                document.getElementById('e-paidBy').value = item.paidBy;
                document.getElementById('expense-form').scrollIntoView();
            } else if (item.type === 'sale') {
                document.getElementById('s-date').value = item.date.split('T')[0];
                document.getElementById('s-cust').value = item.details.replace("Sale: ", "");
                document.getElementById('s-qty').value = item.qty;
                document.getElementById('s-price').value = item.amt / (item.qty || 1);
            }
            alert("Loaded into form. Change values and Save. Delete old row manually.");
        }

        async function deleteRow(rowId) {
            if(!confirm("Delete this entry?")) return;
            document.getElementById('status').innerText = "‚åõ Deleting...";
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete", rowId: rowId }) });
            loadCloudData();
        }

        function calculateStock() {
            let s = { "Straw": 0, "Spawn": 0, "Bavistine": 0, "Formalin": 0, "PP Bags": 0, "Rubber Bands": 0, "Cotton": 0, "Punnets": 0 };
            dbMaster.forEach(i => {
                if(i.type === 'exp' && s.hasOwnProperty(i.details)) s[i.details] += safeNum(i.qty);
                if(i.type === 'yield') { s["Punnets"] -= (safeNum(i.amt) * 5); }
                if(i.type === 'waste' && i.details.includes("Contaminated")) {
                    s["PP Bags"] -= (safeNum(i.amt) * 0.1); s["Straw"] -= (safeNum(i.amt) * 0.5); s["Spawn"] -= (safeNum(i.amt) * 0.1); 
                }
            });
            return s;
        }

        function renderAll() {
            const body = document.getElementById('history-body');
            body.innerHTML = '';
            let te = 0, ts = 0;
            const stock = calculateStock();
            const sDisplay = document.getElementById('stock-display');
            sDisplay.innerHTML = '';
            for(let item in stock) {
                const runway = dailyUsage[item] ? Math.floor(stock[item] / dailyUsage[item]) : 0;
                const isLow = runway < 3;
                const unit = item === "Formalin" ? "L" : (item === "Punnets" ? "pcs" : (item === "Cotton" ? "rolls" : "kg"));
                sDisplay.innerHTML += `<div class="stock-item ${isLow ? 'low-stock' : ''}"><div><b>${item}</b>: ${stock[item].toFixed(1)} ${unit}</div><div style="font-size:10px">${isLow ? '‚ö†Ô∏è REORDER' : runway + 'd left'}</div></div>`;
            }

            dbMaster.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(i => {
                const amt = safeNum(i.amt);
                const qty = safeNum(i.qty);
                let valStr = "";

                if(i.type === 'exp') { te += amt; valStr = `‚Çπ${amt}`; }
                else if(i.type === 'sale') { ts += amt; valStr = `‚Çπ${amt}`; }
                else if(i.type === 'yield') { valStr = `${amt} kg`; }
                else if(i.type === 'waste') { 
                    const unit = i.details.includes('Mushroom') ? 'kg' : 'Bags';
                    valStr = `${amt} ${unit}`; 
                }

                body.innerHTML += `<tr>
                    <td>${i.date.split('T')[0]}</td>
                    <td>${i.details}${i.paidBy&&i.type==='exp' ? `<span class="acc-tag ${i.paidBy}">${i.paidBy[0]}</span>`:''}</td>
                    <td>${valStr}</td>
                    <td><div class="actions"><span onclick="editRow(${i.rowId})">‚úèÔ∏è</span><span onclick="deleteRow(${i.rowId})">üóëÔ∏è</span></div></td>
                </tr>`;
            });
            document.getElementById('exp-total').innerText = '‚Çπ' + te.toLocaleString('en-IN');
            document.getElementById('sales-total').innerText = '‚Çπ' + ts.toLocaleString('en-IN');
            document.getElementById('net-total').innerText = '‚Çπ' + (ts - te).toLocaleString('en-IN');
            updateChart();
        }

        function shareWeeklyReport() {
            const last7Days = new Date(); last7Days.setDate(last7Days.getDate() - 7);
            const weeklyData = dbMaster.filter(i => new Date(i.date) >= last7Days);
            const ws = weeklyData.filter(i => i.type === 'sale').reduce((a, b) => a + safeNum(b.amt), 0);
            const we = weeklyData.filter(i => i.type === 'exp').reduce((a, b) => a + safeNum(b.amt), 0);
            const wh = weeklyData.filter(i => i.type === 'yield').reduce((a, b) => a + safeNum(b.amt), 0);
            const msg = `üçÑ *Oyster Farm Weekly Report* üçÑ%0Aüí∞ *Sales:* ‚Çπ${ws}%0Aüí∏ *Expenses:* ‚Çπ${we}%0Aüìâ *Net Profit:* ‚Çπ${ws - we}%0AüçÑ *Harvest:* ${wh} kg%0A-----------------%0A_Sent via Farm Master Pro_`;
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        }

        function updateChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (myChart) myChart.destroy();
            const dates = [...new Set(dbMaster.map(d => d.date))].sort().slice(-7);
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.split('T')[0]),
                    datasets: [
                        { label: 'Sales', data: dates.map(d => dbMaster.filter(i => i.date === d && i.type === 'sale').reduce((a,b)=>a+safeNum(b.amt),0)), borderColor: '#27ae60', tension: 0.3 },
                        { label: 'Expenses', data: dates.map(d => dbMaster.filter(i => i.date === d && i.type === 'exp').reduce((a,b)=>a+safeNum(b.amt),0)), borderColor: '#e74c3c', tension: 0.3 }
                    ]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
