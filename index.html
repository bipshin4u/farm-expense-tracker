<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyster Farm Master Gold V3</title>
    <style>
        :root { --straw: #f1c40f; --spawn: #9b59b6; --yield: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --success: #27ae60; --bipin: #e8f5e9; --arjun: #e3f2fd; --kotak: #fff9c4; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; color: var(--dark); overflow-y: auto; }
        
        .header-status { background: white; padding: 12px; border-bottom: 1px solid #ddd; text-align: center; position: sticky; top: 0; z-index: 200; }
        .status-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 5px; }
        .sync-btn { background: #eee; border: 1px solid #ccc; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
        .main-container { padding: 10px 15px; }
        .tab-bar { display: flex; background: #eee; margin-bottom: 15px; border-radius: 10px; padding: 4px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 12px; color: #666; }
        .tab-btn.active { background: white; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { background: var(--dark); color: white; font-weight: bold; border: none; cursor: pointer; }
        
        /* Highlighting */
        .row-arjun { background-color: var(--arjun) !important; }
        .row-kotak { background-color: var(--kotak) !important; }
        .row-bipin { background-color: var(--bipin) !important; }
        .row-waste { background-color: #ffebee !important; color: var(--danger) !important; }
        .status-pending { background-color: #ffd7d7 !important; border-left: 5px solid #e74c3c !important; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge-pending { background: #e74c3c; color: white; }
        .badge-paid { background: #2ecc71; color: white; }
        .pay-btn { background: #2ecc71; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; margin-top: 4px; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        td, th { padding: 12px 6px; border-bottom: 1px solid #eee; text-align: left; }
        .action-btn { cursor: pointer; font-size: 16px; margin-right: 8px; display: inline-block; }
        
        #editModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
        .modal-content { background:white; margin:10% auto; padding:20px; width:85%; border-radius:12px; }
    </style>
</head>
<body>

<div class="header-status">
    <div class="status-container">
        <div id="status" style="font-size:11px; font-weight:bold; color: orange;">‚åõ Connecting...</div>
        <div class="sync-btn" onclick="load()">üîÑ</div>
    </div>
    <div class="grid" style="max-width: 400px; margin: 0 auto;">
        <div><small>Bags</small><div id="active-bags" style="font-weight:bold;">0</div></div>
        <div><small>Profit</small><div id="net-profit" style="font-weight:bold; color:var(--success)">‚Çπ0</div></div>
    </div>
</div>

<div class="main-container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="openTab(event, 'tab-prod')">PRODUCTION</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-fin')">FINANCE</button>
    </div>

    <div id="tab-prod" class="tab-content">
        <div class="card">
            <h3>üõ† Production</h3>
            <div class="grid"><input type="number" id="f-qty" placeholder="Bags filled"><button onclick="addData('fill')" style="background:#1abc9c">Save</button></div>
            <div class="grid"><input type="number" step="0.1" id="y-weight" placeholder="Harvest kg"><button onclick="addData('yield')" style="background:var(--yield)">Save</button></div>
        </div>
        <div class="card" style="border-left: 5px solid var(--danger);">
            <h3>‚ö†Ô∏è Wastage</h3>
            <select id="w-type"><option value="Contaminated Bag">Contaminated Bag</option><option value="Spoilt Mushroom">Spoilt Mushroom</option></select>
            <input type="number" step="0.1" id="w-qty" placeholder="Quantity"><button onclick="addData('waste')" style="background:var(--danger)">Record Loss</button>
        </div>
    </div>

    <div id="tab-fin" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üí∞ Transactions</h3>
            <select id="fin-type" onchange="toggleFin(this.value)"><option value="sale">Record Sale</option><option value="exp">Record Expense</option></select>
            
            <div id="div-sale">
                <input type="text" id="s-cust" placeholder="Customer Name">
                <div class="grid"><input type="number" id="s-qty" placeholder="Punnets"><input type="number" id="s-rate" placeholder="Rate"></div>
                <div class="grid">
                    <select id="s-status" onchange="toggleSaleAcc(this.value)"><option value="Pending" selected>Pending</option><option value="Paid">Paid</option></select>
                    <select id="s-acc"><option value="Kotak Account">To: Kotak</option><option value="Bipin">To: Bipin</option><option value="Arjun">To: Arjun</option></select>
                </div>
                <button onclick="addData('sale')" style="background:var(--success)">Save Sale</button>
            </div>

            <div id="div-exp" style="display:none;">
                <select id="e-acc"><option value="Bipin">By: Bipin</option><option value="Arjun">By: Arjun</option><option value="Kotak Account">By: Kotak</option></select>
                <select id="e-cat">
                    <optgroup label="Staff"><option value="Worker: Pallavi Mavshi">Pallavi Mavshi</option><option value="Worker: Bhabhi">Bhabhi</option><option value="Worker: Sangeeta Mavshi">Sangeeta Mavshi</option></optgroup>
                    <optgroup label="Materials"><option value="Material: Straw">Straw</option><option value="Material: Spawn">Spawn</option><option value="Material: Bavistine">Bavistine</option><option value="Material: Formalin">Formalin</option><option value="Material: Punnets">Punnets</option><option value="Material: PP Bags">PP Bags</option></optgroup>
                    <optgroup label="Other"><option value="Rent">Rent</option><option value="Electricity">Electricity</option><option value="Transport">Transport</option><option value="Misc">Misc</option></optgroup>
                </select>
                <input type="number" id="e-amt" placeholder="Amount (‚Çπ)"><input type="number" id="e-qty" placeholder="Qty"><button onclick="addData('exp')" style="background:var(--danger)">Save Expense</button>
            </div>
        </div>
        <div class="card">
            <h3>üìä Ledger (Cash Position)</h3>
            <div id="ledger-summary">Loading...</div>
            <div id="pending-collection" style="margin-top:10px; font-weight:bold; color:var(--danger)"></div>
        </div>
    </div>

    <div class="history-section">
        <div class="history-header">
            <span style="font-weight:bold">üìú HISTORY</span>
            <input type="text" id="h-search" placeholder="üîç Search..." onkeyup="filterHistory()" style="width:100%; padding:10px; margin-top:10px; border-radius:20px; border:1px solid #ddd;">
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Date</th><th>Detail</th><th>Val</th><th>Acc</th><th>Actions</th></tr></thead>
                <tbody id="h-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit</h3>
        <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
        <input type="date" id="edit-date"><input type="text" id="edit-details">
        <div class="grid"><input type="number" id="edit-amt"><input type="number" step="0.1" id="edit-qty"></div>
        <label><small>Account</small></label>
        <select id="edit-paidBy"><option value="Bipin">Bipin</option><option value="Arjun">Arjun</option><option value="Kotak Account">Kotak Account</option></select>
        <div id="edit-status-div">
            <label><small>Status</small></label>
            <select id="edit-status"><option value="Paid">Paid</option><option value="Pending">Pending</option></select>
        </div>
        <div class="grid"><button onclick="closeEdit()">Cancel</button><button onclick="submitEdit()" style="background:var(--success)">Update</button></div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbym2_t7cNf3XN6_OcgFHCkx8LF4dgQm4myKN18Ly1MWktt1RWG_-eCMzV8DVyM9YFHg/exec";
    let db = [];

    function safeSet(id, val) { const el = document.getElementById(id); if (el) el.innerText = val; }

    async function load() {
        safeSet('status', "‚åõ Syncing...");
        try {
            const r = await fetch(GOOGLE_URL + "?t=" + new Date().getTime());
            db = await r.json();
            render();
            safeSet('status', "‚úì Connected");
            document.getElementById('status').style.color = "var(--success)";
        } catch(e) { safeSet('status', "‚ö† Connection Error"); }
    }

    function render() {
        let workers = { "Pallavi Mavshi": 0, "Bhabhi": 0, "Sangeeta Mavshi": 0 };
        let balances = { "Bipin": 0, "Arjun": 0, "Kotak Account": 0 };
        let actB = 0, ts = 0, te = 0, pendingCollect = 0;
        const hBody = document.getElementById('h-body');
        if(!hBody) return;
        hBody.innerHTML = '';
        
        db.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(i => {
            const v = parseFloat(i.amt) || 0;
            const q = parseFloat(i.qty) || 0;
            const detRaw = (i.details || "").toString();
            const rawTag = (i.type || "").toString().trim().toLowerCase();
            const pStatus = (i.status || "Paid");

            // ACCOUNT SCANNER
            let rowWho = "";
            for (let key in i) {
                let cellVal = (i[key] || "").toString().toLowerCase();
                if (cellVal.includes("arjun")) { rowWho = "Arjun"; break; }
                if (cellVal.includes("kotak")) { rowWho = "Kotak"; break; }
                if (cellVal.includes("bipin")) { rowWho = "Bipin"; break; }
            }
            
            let rowClass = "";
            let displayBy = rowWho || "Bipin"; 

            if (rawTag === 'exp' || detRaw.toLowerCase().startsWith('expense:')) {
                te += v;
                balances[displayBy] -= v;
                if (displayBy === "Arjun") rowClass = "row-arjun";
                else if (displayBy === "Kotak Account") rowClass = "row-kotak";
                else rowClass = "row-bipin";
            }

            if (rawTag === 'sale') {
                ts += v;
                if(pStatus === "Pending") {
                    rowClass = "status-pending";
                    pendingCollect += v;
                    displayBy = "-";
                } else {
                    balances[displayBy] += v;
                    if (displayBy === "Arjun") rowClass = "row-arjun";
                    else if (displayBy === "Kotak Account") rowClass = "row-kotak";
                    else rowClass = "row-bipin";
                }
            }

            if (rawTag === 'waste') rowClass = "row-waste";
            if (rawTag === 'fill') actB += q;
            if (rawTag === 'waste' && detRaw.toLowerCase().includes("contaminated")) actB -= q;
            if (detRaw.toLowerCase().includes("pallavi")) workers["Pallavi Mavshi"] += v;
            else if (detRaw.toLowerCase().includes("sangeeta")) workers["Sangeeta Mavshi"] += v;
            else if (detRaw.toLowerCase().includes("bhabhi")) workers["Bhabhi"] += v;

            let badge = (rawTag === 'sale') ? `<span class="badge ${pStatus === 'Pending' ? 'badge-pending' : 'badge-paid'}">${pStatus.toUpperCase()}</span>` : "";
            let payBtn = (rawTag === 'sale' && pStatus === 'Pending') ? `<button class="pay-btn" onclick="markAsPaid(${i.rowId})">Collect</button>` : "";

            hBody.innerHTML += `<tr class="${rowClass}">
                <td>${(i.date||"").split('T')[0].substring(5)}</td>
                <td>${detRaw} ${badge}</td>
                <td>${v || q}</td>
                <td>${displayBy}</td> 
                <td>
                    <span class="action-btn" onclick="startEdit(${i.rowId})">‚úèÔ∏è</span>
                    <span class="action-btn" onclick="delEntry(${i.rowId})">üóëÔ∏è</span>
                    ${payBtn}
                </td>
            </tr>`;
        });

        safeSet('net-profit', '‚Çπ' + (ts - te).toFixed(2));
        safeSet('active-bags', actB);
        safeSet('pending-collection', "Pending Collection: ‚Çπ" + pendingCollect.toFixed(2));
        
        const ledSum = document.getElementById('ledger-summary');
        if(ledSum) {
            let html = `<b>Staff Totals (Out)</b><hr>`;
            for(let w in workers) { html += `<div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;"><span>${w}</span><b>‚Çπ${workers[w].toFixed(2)}</b></div>`; }
            html += `<br><b>Net Cash in Account</b><hr>`;
            for(let acc in balances) { 
                let color = balances[acc] >= 0 ? 'var(--success)' : 'var(--danger)';
                html += `<div style="display:flex; justify-content:space-between; font-size:12px; margin:4px 0;"><span>${acc}</span><b style="color:${color}">‚Çπ${balances[acc].toFixed(2)}</b></div>`; 
            }
            ledSum.innerHTML = html;
        }
    }

    async function addData(type) {
        let p = { action:"add", type, date: new Date().toISOString().split('T')[0], details:"", amt:0, qty:0, paidBy: "", status: "Pending" };
        if(type==='exp'){ p.paidBy = document.getElementById('e-acc').value; p.details=document.getElementById('e-cat').value; p.amt=document.getElementById('e-amt').value; p.qty=document.getElementById('e-qty').value; p.status = "Paid"; } // Expenses are always "Paid" by default
        if(type==='fill'){ p.qty=document.getElementById('f-qty').value; p.details="Bags Filled"; }
        if(type==='yield'){ p.amt=document.getElementById('y-weight').value; p.details="Harvest"; }
        if(type==='waste'){ p.qty=document.getElementById('w-qty').value; p.details="Waste: " + document.getElementById('w-type').value; }
        if(type==='sale'){ 
            p.qty=document.getElementById('s-qty').value; 
            p.amt=p.qty*document.getElementById('s-rate').value; 
            p.details="Sale: "+document.getElementById('s-cust').value;
            p.status=document.getElementById('s-status').value;
            // Only assign an account if it's marked as Paid
            p.paidBy = (p.status === "Pending") ? "" : document.getElementById('s-acc').value;
        }
        
        safeSet('status', "‚åõ Saving...");
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        document.querySelectorAll('.main-container input').forEach(input => { input.value = ''; });
        setTimeout(load, 1500);
    }

    async function markAsPaid(id) {
        let entry = db.find(x => x.rowId == id);
        let acc = prompt("Receive into which account? (Kotak/Bipin/Arjun)", "Kotak Account");
        if(!acc) return;
        let p = { action:"edit", rowId:id, date:entry.date, type:entry.type, details:entry.details, amt:entry.amt, qty:entry.qty, paidBy:acc, status:"Paid" };
        safeSet('status', "‚åõ Updating Account...");
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        setTimeout(load, 1500);
    }

    async function delEntry(id) {
        if(confirm("Delete?")) {
            safeSet('status', "‚åõ Deleting...");
            await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:"delete", rowId:id})});
            setTimeout(load, 1500);
        }
    }

    function startEdit(id) {
        let i = db.find(x => x.rowId == id);
        if(!i) return;
        document.getElementById('edit-id').value = i.rowId;
        document.getElementById('edit-type').value = i.type;
        document.getElementById('edit-date').value = (i.date||"").split('T')[0];
        document.getElementById('edit-details').value = i.details;
        document.getElementById('edit-amt').value = i.amt;
        document.getElementById('edit-qty').value = i.qty;
        document.getElementById('edit-status-div').style.display = (i.type === 'sale') ? 'block' : 'none';
        document.getElementById('edit-status').value = i.status || 'Paid';
        document.getElementById('edit-paidBy').value = i.paidBy || 'Bipin';
        document.getElementById('editModal').style.display = 'block';
    }

    async function submitEdit() {
        let p = { action:"edit", rowId: document.getElementById('edit-id').value, type: document.getElementById('edit-type').value, date: document.getElementById('edit-date').value, details: document.getElementById('edit-details').value, amt: document.getElementById('edit-amt').value, qty: document.getElementById('edit-qty').value, paidBy: document.getElementById('edit-paidBy').value, status: document.getElementById('edit-status').value };
        safeSet('status', "‚åõ Updating...");
        await fetch(GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        closeEdit(); setTimeout(load, 1500);
    }

    function toggleFin(v) { document.getElementById('div-sale').style.display = v==='sale'?'block':'none'; document.getElementById('div-exp').style.display = v==='exp'?'block':'none'; }
    function toggleSaleAcc(v) { document.getElementById('s-acc').style.visibility = (v === 'Pending') ? 'hidden' : 'visible'; }
    function filterHistory() {
        let val = document.getElementById('h-search').value.toLowerCase();
        document.querySelectorAll('#h-body tr').forEach(r => { r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none'; });
    }
    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).style.display='block'; e.currentTarget.classList.add('active');
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    window.onload = load;
</script>
</body>
</html>
